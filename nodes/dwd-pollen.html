<script type="text/html" data-template-name="dwd-pollen">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="DWD Pollen (NRW West)">
    </div>

    <div class="form-row">
        <label for="node-input-region"><i class="fa fa-map"></i> Region</label>
        <select id="node-input-region" style="width: 100%;">
            <option value="">– wird geladen … –</option>
        </select>
        <div class="form-tips">
            Die Regionen/Teilregionen stammen aus dem offiziellen DWD-Pollenfeed.
            Siehe auch <a href="https://www.dwd.de/DE/leistungen/gefahrenindizespollen/Gebiete.html"
                          target="_blank" rel="noopener noreferrer">DWD – Pollen-Gebiete</a>.
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-partregion"><i class="fa fa-map-signs"></i> Teilregion</label>
        <select id="node-input-partregion" style="width: 100%;">
            <option value="">– bitte Region wählen –</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-refresh"><i class="fa fa-clock-o"></i> Auto-Refresh (Sek.)</label>
        <input type="number" id="node-input-refresh" min="0" placeholder="0 = aus">
        <div class="form-tips">
            Optional: ruft den Pollenfeed automatisch alle X Sekunden ab (0 = deaktiviert).
        </div>
    </div>
</script>

<script type="text/html" data-help-name="dwd-pollen">
    <p>
        Liest den offiziellen DWD-Pollen-JSON-Feed und liefert die Belastung je Pollenart
        (heute/heute+1/heute+2) für eine gewählte Region & Teilregion.
    </p>
    <p>
        Die Auswahllisten werden beim Öffnen der Node aus dem DWD-Feed geladen
        (über einen internen Proxy-Endpoint dieses Nodes).
    </p>
    <p>
        Weitere Infos & Gebietsübersicht:
        <a href="https://www.dwd.de/DE/leistungen/gefahrenindizespollen/Gebiete.html"
           target="_blank" rel="noopener noreferrer">DWD – Pollen-Gebiete</a>
    </p>
</script>

<script type="text/javascript">
    (function() {
        RED.nodes.registerType('dwd-pollen', {
            category: 'function',
            color: '#B5E3C6',
            defaults: {
                name:       { value: "" },
                region:     { value: "", required: true },
                partregion: { value: "", required: true },
                refresh:    { value: 0, validate: function(v){
                        var n = Number(v); return !isNaN(n) && n >= 0;
                    }}
            },
            inputs: 1,
            outputs: 1,
            icon: "font-awesome/fa-leaf",
            label: function() { return this.name || "DWD Pollen"; },

            oneditprepare: function () {
                const $regionSel     = $("#node-input-region");
                const $partregionSel = $("#node-input-partregion");

                const currentRegion     = this.region || "";
                const currentPartregion = this.partregion || "";

                function populateRegions(regions) {
                    $regionSel.empty();
                    $regionSel.append($("<option/>",{value:"", text:"– bitte wählen –"}));
                    regions.forEach(r => {
                        $regionSel.append($("<option/>",{ value: r.id, text: `${r.id} – ${r.name}` }));
                    });
                    if (currentRegion) { $regionSel.val(String(currentRegion)); }
                    populatePartregions(regions, $regionSel.val());
                }

                function populatePartregions(regions, regionId) {
                    $partregionSel.empty();
                    if (!regionId) {
                        $partregionSel.append($("<option/>",{value:"", text:"– bitte Region wählen –"}));
                        return;
                    }
                    const r = regions.find(x => String(x.id) === String(regionId));
                    if (!r) {
                        $partregionSel.append($("<option/>",{value:"", text:"– keine Teilregionen –"}));
                        return;
                    }
                    $partregionSel.append($("<option/>",{value:"", text:"– bitte wählen –"}));
                    r.parts.forEach(p => {
                        $partregionSel.append($("<option/>",{ value: p.id, text: `${p.id} – ${p.name}` }));
                    });
                    if (currentPartregion) { $partregionSel.val(String(currentPartregion)); }
                }

                // Regions abrufen über Admin-Proxy
                $.getJSON("dwd-pollen/regions")
                    .done(function(resp){
                        if (resp && Array.isArray(resp.regions)) {
                            populateRegions(resp.regions);
                        } else {
                            $regionSel.empty().append($("<option/>",{value:"", text:"Fehler beim Laden"}));
                        }
                    })
                    .fail(function(){
                        $regionSel.empty().append($("<option/>",{value:"", text:"Laden fehlgeschlagen"}));
                    });

                // Abhängige Teilregionen
                $regionSel.on("change", function(){
                    const regionId = $(this).val();
                    $.getJSON("dwd-pollen/regions").done(function(resp){
                        populatePartregions(resp.regions, regionId);
                    });
                });
            }
        });
    })();
</script>