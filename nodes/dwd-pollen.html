<script type="text/html" data-template-name="dwd-pollen">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="DWD Pollen" />
    </div>

    <div class="form-row">
        <label for="node-input-regionId"><i class="fa fa-map"></i> Region</label>
        <select id="node-input-regionId" style="width: 100%;">
            <option value="">— Bitte wählen —</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-partregionId"><i class="fa fa-map-pin"></i> Teilregion</label>
        <select id="node-input-partregionId" style="width: 100%;" disabled>
            <option value="">— Bitte Region wählen —</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-regionName"><i class="fa fa-tag"></i> Region-Name</label>
        <input type="text" id="node-input-regionName" placeholder="(optional, wird beim Auswählen gesetzt)">
    </div>

    <div class="form-row">
        <label for="node-input-partregionName"><i class="fa fa-tag"></i> Teilregion-Name</label>
        <input type="text" id="node-input-partregionName" placeholder="(optional, wird beim Auswählen gesetzt)">
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-fetchOnDeploy"><i class="fa fa-bolt"></i> Bei Deploy abrufen</label>
        <input type="checkbox" id="node-input-fetchOnDeploy" style="width:auto; margin-left:6px;">
        <span class="form-tips">Beim Deploy sofort eine Anfrage an den DWD senden.</span>
    </div>

    <div class="form-row">
        <label for="node-input-autoRefreshSec">
            <i class="fa fa-refresh"></i> Auto-Refresh (Sek.)
        </label>
        <input type="number" id="node-input-autoRefreshSec" min="0" placeholder="0 = aus">
    </div>

    <div class="form-tips">
        Automatische Aktualisierung im Intervall. 0 oder leer = deaktiviert.
    </div>
    <div class="form-tips">
        Die Listen werden aus dem offiziellen DWD-Pollenfeed geladen.
        Alternativ können <code>msg.regionId</code> bzw. <code>msg.partregionId</code> gesetzt werden.
    </div>
</script>

<script type="text/html" data-help-name="dwd-pollen">
    <p><b>DWD Pollen</b> – ruft die Pollenflug-Informationen des Deutschen Wetterdienstes (DWD) ab.</p>
    <ul>
        <li>Wähle <b>Region</b> → dann stehen passende <b>Teilregionen</b> zur Auswahl.</li>
        <li>Optional: <i>Bei Deploy abrufen</i> und <i>Auto-Refresh</i> (Sekunden) konfigurieren.</li>
        <li>Zur Laufzeit können <code>msg.regionId</code>/<code>msg.partregionId</code> die Konfiguration überschreiben.</li>
    </ul>
    <p>Quelle: <code>https://opendata.dwd.de/climate_environment/health/alerts/s31fg.json</code></p>
</script>

<script type="text/javascript">
    (function() {
        RED.nodes.registerType('dwd-pollen', {
            category: 'weather',
            color: '#9ed2f6',
            defaults: {
                name: { value: "" },
                regionId: { value: "" },
                partregionId: { value: "" },
                regionName: { value: "" },
                partregionName: { value: "" },
                fetchOnDeploy: { value: true },
                autoRefreshSec: { value: 0, validate: function(v){ return (v === "" || !isNaN(v)) && v >= 0; } }
            },
            inputs: 1,
            outputs: 1,
            icon: "font-awesome/fa-leaf",
            label: function() {
                return this.name || "DWD Pollen";
            },
            oneditprepare: function() {
                const $region = $("#node-input-regionId");
                const $part   = $("#node-input-partregionId");
                const $rName  = $("#node-input-regionName");
                const $pName  = $("#node-input-partregionName");

                function setPartDisabled(disabled, msg) {
                    $part.prop("disabled", !!disabled);
                    $part.find("option").remove();
                    const opt = $("<option/>").val("").text(msg || (disabled ? "— Bitte Region wählen —" : "— Bitte wählen —"));
                    $part.append(opt);
                }

                function populateRegions(regions, preselectId) {
                    $region.find("option").remove();
                    $region.append($("<option/>").val("").text("— Bitte wählen —"));

                    regions.forEach(r => {
                        $region.append($("<option/>").val(r.id).text(`${r.name} (${r.id})`).data("parts", r.parts));
                    });

                    if (preselectId) {
                        $region.val(preselectId);
                    }
                }

                function populateParts(parts, preselectId) {
                    setPartDisabled(false, "— Bitte wählen —");
                    parts.forEach(p => {
                        $part.append($("<option/>").val(p.id).text(`${p.name} (${p.id})`));
                    });
                    if (preselectId) {
                        $part.val(preselectId);
                    }
                }

                // Regionen laden
                $.getJSON("dwd-pollen/regions")
                    .done(json => {
                        const regions = Array.isArray(json?.regions) ? json.regions : [];
                        populateRegions(regions, this.regionId);

                        const selected = $region.find("option:selected").data("parts");
                        if (selected && selected.length) {
                            populateParts(selected, this.partregionId);
                        } else {
                            setPartDisabled(true);
                        }
                    })
                    .fail(() => {
                        setPartDisabled(true, "Laden der Regionen fehlgeschlagen");
                    });

                // Change-Handler: Region → Teilregionen
                $region.on("change", function() {
                    const opt = $(this).find("option:selected");
                    const parts = opt.data("parts") || [];
                    const txt = opt.text();
                    const m = txt.match(/^(.*)\s\(/);
                    if (m) { $rName.val(m[1].trim()); }

                    if (parts.length) {
                        populateParts(parts, "");
                    } else {
                        setPartDisabled(true);
                        $pName.val("");
                    }
                });

                // Change-Handler: Teilregion → Namen setzen
                $part.on("change", function() {
                    const txt = $(this).find("option:selected").text();
                    const m = txt.match(/^(.*)\s\(/);
                    if (m) { $pName.val(m[1].trim()); }
                });
            }
        });
    })();
</script>