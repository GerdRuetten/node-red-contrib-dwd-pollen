<script type="text/javascript">
    RED.nodes.registerType('dwd-pollen', {
        category: 'function',
        color: '#d9edf7',
        icon: 'font-awesome/fa-leaf',
        align: 'left',
        defaults: {
            name: { value: "DWD-Pollen" },
            // Auswahlstrategie
            partRegionId: { value: "", validate: function(v){ return true; } },
            regionName: { value: "" },           // Freitext (z.B. "Nordrhein-Westfalen")
            partRegionName: { value: "" },       // Freitext (z.B. "Niederrhein")
            allowNameFallback: { value: true },  // Checkbox
            extraNames: { value: "" },           // zusätzliche Namen (Komma-getrennt)

            // Filter für Tage
            dayMode: { value: "today", required: true }, // today|tomorrow|day_after_tomorrow|all

            // Betriebsoptionen
            fetchOnDeploy: { value: true },
            autoRefreshSec: { value: 0 }, // 0 = aus

            // Ausgabeoptionen (Texte)
            includeTextLevels: { value: true }
        },
        inputs: 1,
        outputs: 1,
        outputLabels: ["pollen"],
        label: function () {
            return this.name || "DWD-Pollen";
        },
        oneditprepare: function () {
            $("#node-input-dayMode").val(this.dayMode || "today");
        }
    });
</script>

<script type="text/html" data-template-name="dwd-pollen">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Node-Name</label>
        <input type="text" id="node-input-name" placeholder="DWD-Pollen">
    </div>

    <hr/>

    <div class="form-row">
        <label><i class="fa fa-map-marker"></i> Partregion-ID</label>
        <input type="text" id="node-input-partRegionId" placeholder="z. B. 805 (optional)">
    </div>
    <div class="form-row">
        <label><i class="fa fa-map"></i> Region-Name</label>
        <input type="text" id="node-input-regionName" placeholder="z. B. Nordrhein-Westfalen (optional)">
    </div>
    <div class="form-row">
        <label><i class="fa fa-map-o"></i> Teilregion-Name</label>
        <input type="text" id="node-input-partRegionName" placeholder="z. B. Niederrhein (optional)">
    </div>
    <div class="form-row">
        <label><i class="fa fa-exchange"></i> Name-Fallback zulassen</label>
        <input type="checkbox" id="node-input-allowNameFallback" style="width:auto;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-plus"></i> zusätzliche Gebiets­namen</label>
        <input type="text" id="node-input-extraNames" placeholder="Komma-getrennt, optional">
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-dayMode"><i class="fa fa-calendar"></i> Zeitraum</label>
        <select id="node-input-dayMode">
            <option value="today">nur heute</option>
            <option value="tomorrow">nur morgen</option>
            <option value="day_after_tomorrow">nur übermorgen</option>
            <option value="all">alle (heute+morgen+übermorgen)</option>
        </select>
    </div>

    <hr/>

    <div class="form-row">
        <label><i class="fa fa-rocket"></i> Beim Deploy sofort abrufen</label>
        <input type="checkbox" id="node-input-fetchOnDeploy" style="width:auto;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-refresh"></i> Auto-Refresh (Sek.)</label>
        <input type="number" id="node-input-autoRefreshSec" min="0" placeholder="0 = aus">
    </div>

    <div class="form-row">
        <label><i class="fa fa-commenting"></i> Text-Beschreibungen</label>
        <input type="checkbox" id="node-input-includeTextLevels" style="width:auto;">
    </div>

    <div class="form-tips">
        Datenquelle: DWD Pollenflug-Gefahrenindex <code>s31fg.json</code> (täglich). Struktur/Doku: siehe DWD PDF.
    </div>
</script>

<script type="text/html" data-help-name="dwd-pollen">
    <p>
        Liest den offiziellen DWD Pollenflug-Gefahrenindex (JSON <code>s31fg.json</code>) und gibt die Werte für
        eine Region/Teilregion aus (heute, morgen, übermorgen).
    </p>
    <p>
        Quellen:<br/>
        • Verzeichnis & Datei: <code>.../health/alerts/s31fg.json</code><br/>
        • PDF-Beschreibung: „Beschreibung_pollen_s31fg.pdf“
    </p>
    <p>Konfiguration:
    <ul>
        <li><b>Partregion-ID</b> (präferiert). Alternativ Region-/Teilregion-Namen und <i>Name-Fallback</i>.</li>
        <li><b>Zeitraum</b>: heute / morgen / übermorgen / alle.</li>
        <li><b>Beim Deploy abrufen</b> und <b>Auto-Refresh</b> in Sekunden.</li>
        <li><b>Text-Beschreibungen</b>: numerische Stufen in Klartext (z. B. „mäßig“).</li>
    </ul>
    </p>
    <p>Output:
    <pre>{
  "payload": {
    "pollen": {
      "Birke": {"today":2,"tomorrow":1,"day_after_tomorrow":0,"text":{"today":"mäßig",...}},
      ...
    },
    "region": {"id":101,"region_name":"Nordrhein-Westfalen","partregion_name":"Niederrhein"},
    "last_update": "2025-10-27T10:35:00Z"
  },
  "_meta": {"source":"DWD s31fg.json","url":"https://opendata.dwd.de/.../s31fg.json"}
}</pre>
    </p>
</script>